import{d as K,e as Y,f as Z,o as _,c as S,F as V,a,t as O,n as U,r as z,p as j,T as ae,s as oe,g as q,b as k,i as se,_ as J,w as ne,k as re,u as G,q as le}from"./index-CWkIdGNN.js";import{H as F}from"./hammer-BRjDnnGP.js";import{p as R}from"./persistenceService-D2TLTx3Y.js";import{a as L,S as B,v as W,V as A}from"./vibrationService-DXRESRMj.js";var M=(o=>(o.UP="up",o.DOWN="down",o.LEFT="left",o.RIGHT="right",o))(M||{});const m=4,ie=2,ue=30,ce=.1,de={class:"game2048-board"},ve={class:"game-header"},me={class:"game-status"},fe={class:"score-container"},ge={class:"score-box"},we={class:"score-value"},pe={class:"score-box"},he={class:"score-value"},ye={class:"grid-background"},be={key:0,class:"game-over-overlay"},_e={key:1,class:"game-won-overlay"},Se=K({__name:"Game2048Board",props:{tiles:{},score:{},bestScore:{},gameOver:{type:Boolean},gameWon:{type:Boolean},statusText:{}},emits:["move","restart","continue"],setup(o,{emit:v}){const i=v,u=k(null);let l=null;function x(c){const n=100/m,s=1.5;return{left:`${c.col*n+s}%`,top:`${c.row*n+s}%`,width:`${n-s*2}%`,height:`${n-s*2}%`}}function y(c){const s={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",w:"up",s:"down",a:"left",d:"right"}[c.key];s&&(c.preventDefault(),i("move",s))}function T(){if(!u.value)return;l=new F.Manager(u.value);const c=new F.Swipe({direction:F.DIRECTION_ALL,threshold:ue});l.add(c),l.on("swipeleft",()=>i("move","left")),l.on("swiperight",()=>i("move","right")),l.on("swipeup",()=>i("move","up")),l.on("swipedown",()=>i("move","down"))}function g(){l&&(l.destroy(),l=null)}function w(){i("restart")}function b(){i("continue")}return Y(()=>{window.addEventListener("keydown",y),T()}),Z(()=>{window.removeEventListener("keydown",y),g()}),(c,n)=>(_(),S(V,null,[a("div",de,[a("div",ve,[n[0]||(n[0]=a("div",{class:"game-title"},"2048",-1)),a("div",me,O(o.statusText),1)]),a("div",fe,[a("div",ge,[n[1]||(n[1]=a("div",{class:"score-label"},"分数",-1)),a("div",we,O(o.score),1)]),a("div",pe,[n[2]||(n[2]=a("div",{class:"score-label"},"最高分",-1)),a("div",he,O(o.bestScore),1)])]),a("div",{ref_key:"boardRef",ref:u,class:U(["board",{"game-over":o.gameOver,"game-won":o.gameWon}])},[a("div",ye,[(_(),S(V,null,z(16,s=>a("div",{key:`bg-${s}`,class:"grid-cell"})),64))]),j(ae,{name:"tile"},{default:oe(()=>[(_(!0),S(V,null,z(o.tiles,s=>(_(),S("div",{key:s.id,class:U(["tile",[`tile-${s.value}`,{"tile-new":s.isNew,"tile-merged":s.isMerged}]]),style:se(x(s))},O(s.value),7))),128))]),_:1})],2),a("div",{class:"game-controls"},[a("button",{class:"control-button",onClick:w},"重新开始"),n[3]||(n[3]=a("div",{class:"control-hint"},"使用方向键或滑动来移动方块",-1))])]),o.gameOver?(_(),S("div",be,[a("div",{class:"overlay-content"},[n[4]||(n[4]=a("div",{class:"overlay-title"},"游戏结束",-1)),a("button",{class:"overlay-button",onClick:w}," 再来一局 ")])])):q("",!0),o.gameWon?(_(),S("div",_e,[a("div",{class:"overlay-content"},[n[5]||(n[5]=a("div",{class:"overlay-title"},"你赢了！",-1)),n[6]||(n[6]=a("div",{class:"overlay-subtitle"},"达到 2048",-1)),a("div",{class:"overlay-buttons"},[a("button",{class:"overlay-button",onClick:w}," 再来一局 "),a("button",{class:"overlay-button overlay-button-secondary",onClick:b}," 继续游戏 ")])])])):q("",!0)],64))}}),Te=J(Se,[["__scopeId","data-v-4d97ff7e"]]);function Ee(){const o=k([]),v=k(0),i=k(0),u=k(!1),l=k(!1);function x(){const e={tiles:o.value.map(t=>({id:t.id,value:t.value,row:t.row,col:t.col})),gameOver:u.value,gameWon:l.value};R.saveGame2048({stats:{score:v.value,bestScore:i.value},gameState:e})}function y(){const e=R.loadGame2048();v.value=e.stats.score,i.value=e.stats.bestScore,e.gameState?(o.value=e.gameState.tiles.map(t=>({...t,mergedFrom:void 0,isNew:!1,isMerged:!1})),u.value=e.gameState.gameOver,l.value=e.gameState.gameWon,g=Math.max(...o.value.map(t=>t.id),0)+1):b()}function T(){const e=R.loadGame2048();R.saveGame2048({stats:e.stats,gameState:null})}ne([v,i,o,u,l],()=>{!u.value&&!l.value&&x()},{deep:!0}),y();let g=0;const w=re(()=>l.value?"你赢了！":u.value?"游戏结束":"游戏中");function b(){o.value=[],v.value=0,u.value=!1,l.value=!1,g=0;for(let e=0;e<ie;e++)c()}function c(){const e=n();if(e.length===0)return;const t=e[Math.floor(Math.random()*e.length)],r=Math.random()<ce?4:2,d={id:g++,value:r,row:t.row,col:t.col,isNew:!0};o.value.push(d)}function n(){const e=[];for(let t=0;t<m;t++)for(let r=0;r<m;r++)s(t,r)||e.push({row:t,col:r});return e}function s(e,t){return o.value.find(r=>r.row===e&&r.col===t)}function p(e){if(u.value||l.value)return!1;o.value.forEach(E=>{E.isMerged=!1,E.isNew=!1,delete E.mergedFrom});let t=!1,r=!1;const d=C(e),D=N(d);return D.forEach(E=>{D.forEach(P=>{const f=s(E,P);if(f){const h=Q(E,P,d),I=s(h.next.row,h.next.col);if(I&&I.value===f.value&&!I.isMerged){const $={id:g++,value:f.value*2,row:h.next.row,col:h.next.col,mergedFrom:[f,I],isMerged:!0};o.value=o.value.filter(H=>H.id!==f.id&&H.id!==I.id),o.value.push($),v.value+=$.value,r=!0,$.value===2048&&(l.value=!0),t=!0}else(f.row!==h.farthest.row||f.col!==h.farthest.col)&&(f.row=h.farthest.row,f.col=h.farthest.col,t=!0)}})}),t&&(c(),ee(),r?(L.play(B.MERGE),W.vibrate(A.MERGE),l.value&&(L.play(B.WIN),W.vibrate(A.WIN))):(L.play(B.MOVE),W.vibrate(A.MOVE)),X()||(u.value=!0,L.play(B.LOSE),W.vibrate(A.LOSE))),t}function C(e){return{[M.UP]:{row:-1,col:0},[M.DOWN]:{row:1,col:0},[M.LEFT]:{row:0,col:-1},[M.RIGHT]:{row:0,col:1}}[e]}function N(e){const t=[];for(let r=0;r<m;r++)t.push(r);return e.row===1&&t.reverse(),e.col===1&&t.reverse(),t}function Q(e,t,r){let d;do d={row:e,col:t},e+=r.row,t+=r.col;while(e>=0&&e<m&&t>=0&&t<m&&!s(e,t));return{farthest:d,next:{row:e,col:t}}}function X(){if(n().length>0)return!0;for(let e=0;e<m;e++)for(let t=0;t<m;t++){const r=s(e,t);if(r){if(t<m-1){const d=s(e,t+1);if(d&&d.value===r.value)return!0}if(e<m-1){const d=s(e+1,t);if(d&&d.value===r.value)return!0}}}return!1}function ee(){v.value>i.value&&(i.value=v.value)}function te(){b(),T()}return{tiles:o,score:v,bestScore:i,gameOver:u,gameWon:l,statusText:w,initGame:b,move:p,restartGame:te,loadGameState:y,clearGameState:T}}const Ge={class:"game2048-view"},ke={class:"container"},xe={class:"game-layout"},Ie={class:"game-main"},Me=K({__name:"Game2048View",setup(o){const v=le(),{tiles:i,score:u,bestScore:l,gameOver:x,gameWon:y,statusText:T,move:g,restartGame:w}=Ee();function b(p){g(p)}function c(){w()}function n(){w()}function s(){v.push("/")}return Y(()=>{const p=new BroadcastChannel("woodcat-games");p.onmessage=C=>{const N=C.data;N.type==="close-game"&&N.gameRoute!=="/game/2048"&&(p.close(),window.close())},Z(()=>{p.close()})}),(p,C)=>(_(),S("div",Ge,[a("div",ke,[a("div",{class:"game-header"},[a("button",{onClick:s,class:"back-button"},"← 返回首页")]),a("div",xe,[a("div",Ie,[j(Te,{tiles:G(i),score:G(u),"best-score":G(l),"game-over":G(x),"game-won":G(y),"status-text":G(T),onMove:b,onRestart:c,onContinue:n},null,8,["tiles","score","best-score","game-over","game-won","status-text"])])])])]))}}),Le=J(Me,[["__scopeId","data-v-8df6cd99"]]);export{Le as default};
